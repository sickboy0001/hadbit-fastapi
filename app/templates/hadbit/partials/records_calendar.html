<div class="w-full bg-base-100 p-2 rounded-lg border border-base-200">
  <div class="flex mb-4">
    <div class="join">
      <button
        class="join-item btn btn-sm btn-active btn-primary"
        onclick="filterCalendarEvents(this, '')"
      >
        全て
      </button>
      {% set unique_parents = [] %} {% set seen_ids = [] %} {% for log in logs
      %} {% if log.parent_item_id and log.parent_item_id not in seen_ids %} {%
      set _ = seen_ids.append(log.parent_item_id) %} {% set _ =
      unique_parents.append({'id': log.parent_item_id, 'name':
      log.parent_short_name}) %} {% endif %} {% endfor %} {% for parent in
      unique_parents %}
      <button
        class="join-item btn btn-sm"
        onclick="filterCalendarEvents(this, '{{ parent.id }}')"
      >
        {{ parent.name }}
      </button>
      {% endfor %}
    </div>
  </div>
  <div id="calendar"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
<script>
  (function() {
    const calendarEl = document.getElementById('calendar');
    if (!calendarEl) return;

    // 現在の月の前月を初期表示位置にする
    const today = new Date();
    const startDate = new Date(today.getFullYear(), today.getMonth() - 1, 1);

    const calendar = new FullCalendar.Calendar(calendarEl, {
      initialDate: startDate,
      initialView: 'multiMonthTwoMonth',
      views: {
        multiMonthTwoMonth: {
          type: 'multiMonthYear',
          duration: { months: 2 },
          dateIncrement: { months: 1 }
        }
      },
      multiMonthMaxColumns: 1,
      locale: 'ja',
      height: 'auto',
      headerToolbar: {
        left: 'prev,next today',
        center: 'title',
        right: ''
      },
      buttonText: {
        today: '今日',
      },
      firstDay: 0, // 日曜日始まり
      events: [
        {% for log in logs %}
        {
          title: '{{ log.child_name }}',
          start: '{{ log.done_at.isoformat() }}',
          allDay: false,
          backgroundColor: 'oklch(var(--p))',
          borderColor: 'oklch(var(--p))',
          textColor: 'oklch(var(--pc))',
          extendedProps: {
            parentId: '{{ log.parent_item_id }}'
          }
        },
        {% endfor %}
      ],
      eventTimeFormat: {
        hour: '2-digit',
        minute: '2-digit',
        meridiem: false
      }
    });

    // フィルタリング関数をグローバルに定義
    window.filterCalendarEvents = function(btn, parentId) {
      // ボタンのアクティブ状態切り替え
      const container = btn.closest('.join');
      container.querySelectorAll('.btn').forEach(b => {
        b.classList.remove('btn-active', 'btn-primary');
      });
      btn.classList.add('btn-active', 'btn-primary');

      // イベントの表示切り替え
      calendar.getEvents().forEach(event => {
        if (!parentId || event.extendedProps.parentId == parentId) {
          event.setProp('display', 'auto');
        } else {
          event.setProp('display', 'none');
        }
      });
    };

    // タブ切り替え時の表示崩れ防止（コンテナが表示されたタイミングで再描画）
    const observer = new ResizeObserver(entries => {
      for (let entry of entries) {
        if (entry.contentRect.width > 0) {
          calendar.render();
        }
      }
    });
    observer.observe(calendarEl);
  })();
</script>
