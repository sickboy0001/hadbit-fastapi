{% from "hadbit/partials/popmenu_macros.html" import render_log_row %}
<div class="w-full bg-base-100 p-4 rounded-lg border border-base-200">
  <div class="flex mb-4">
    <div class="join">
      <button
        class="join-item btn btn-sm btn-active btn-primary"
        onclick="filterHeatmap(this, '')"
      >
        全て
      </button>
      {% set unique_parents = [] %} {% set seen_ids = [] %} {% for log in logs
      %} {% if log.parent_item_id and log.parent_item_id not in seen_ids %} {%
      set _ = seen_ids.append(log.parent_item_id) %} {% set _ =
      unique_parents.append({'id': log.parent_item_id, 'name':
      log.parent_short_name}) %} {% endif %} {% endfor %} {% for parent in
      unique_parents %}
      <button
        class="join-item btn btn-sm"
        onclick="filterHeatmap(this, '{{ parent.id }}')"
      >
        {{ parent.name }}
      </button>
      {% endfor %}
    </div>
  </div>
  <div class="w-full mt-4 overflow-x-auto">
    <div
      id="echarts-heatmap"
      style="min-width: 800px; height: 200px; margin: 0 auto"
    ></div>
  </div>

  <!-- Selected Date Logs Container -->
  <div
    id="heatmap-selected-date-container"
    class="mt-6 hidden border-t border-base-200 pt-4"
  >
    <h3 id="heatmap-selected-date-title" class="text-lg font-bold mb-4"></h3>
    <div id="heatmap-selected-logs-list" class="flex flex-col gap-2"></div>
  </div>
</div>

<!-- Hidden Source for Logs -->
<div id="heatmap-logs-source" class="hidden">
  {% for log in logs %}
  <div
    class="heatmap-log-entry"
    data-date="{{ log.done_at.strftime('%Y-%m-%d') }}"
  >
    {{ render_log_row(log, update=False) }}
  </div>
  {% endfor %}
</div>

<!-- ECharts -->
<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>

<script>
  (function() {
    // ログデータをJavaScriptオブジェクト配列に変換
    const rawData = [
      {% for log in logs %}
      { date: "{{ log.done_at.isoformat() }}", value: 1, parentId: "{{ log.parent_item_id }}", child: "{{ log.child_short_name | replace("'", "\\'") }}" },
      {% endfor %}
    ];

    // ECharts用のデータ集計
    function getEChartsData(filterParentId) {
      const dataMap = {};
      const details = {}; // 日付ごとの内訳

      rawData.forEach(item => {
        if (!filterParentId || item.parentId === filterParentId) {
          const day = item.date.substring(0, 10);
          dataMap[day] = (dataMap[day] || 0) + item.value;

          // 内訳データの作成
          if (!details[day]) {
            details[day] = { total: 0, breakdown: {} };
          }
          details[day].total += item.value;
          const childName = item.child || '(未設定)';
          details[day].breakdown[childName] = (details[day].breakdown[childName] || 0) + 1;
        }
      });

      // ツールチップから参照可能にする
      window.heatmapDetails = details;
      return Object.keys(dataMap).map(key => [key, dataMap[key]]);
    }

    // EChartsの描画
    var myChart = null;
    function renderECharts(parentId) {
      // 表示期間の計算（今月末から過去1年間）
      const today = new Date();
      const endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0); // 今月末
      const startDate = new Date(endDate);
      startDate.setFullYear(startDate.getFullYear() - 1);
      startDate.setDate(startDate.getDate() + 1);
      const range = [startDate.toISOString().split('T')[0], endDate.toISOString().split('T')[0]];

      // 全期間のデータを0で初期化して作成
      const chartDataMap = new Map();
      let curr = new Date(startDate);
      while (curr <= endDate) {
        const y = curr.getFullYear();
        const m = ('0' + (curr.getMonth() + 1)).slice(-2);
        const d = ('0' + curr.getDate()).slice(-2);
        const dateStr = `${y}-${m}-${d}`;
        chartDataMap.set(dateStr, 0);
        curr.setDate(curr.getDate() + 1);
      }

      // 実データを上書き
      const actualData = getEChartsData(parentId);
      actualData.forEach(item => {
        chartDataMap.set(item[0], item[1]);
      });
      const chartData = Array.from(chartDataMap.entries());

      if (!myChart) {
        const chartDom = document.getElementById('echarts-heatmap');
        myChart = echarts.init(chartDom);

        // Click event handler
        myChart.on('click', function(params) {
          if (params.componentType === 'series') {
            const date = params.data[0];
            const container = document.getElementById('heatmap-selected-date-container');
            const list = document.getElementById('heatmap-selected-logs-list');
            const title = document.getElementById('heatmap-selected-date-title');
            const source = document.getElementById('heatmap-logs-source');

            list.innerHTML = '';
            const entries = source.querySelectorAll(`.heatmap-log-entry[data-date="${date}"]`);

            if (entries.length > 0) {
              title.textContent = date + ' の記録';
              entries.forEach(entry => {
                Array.from(entry.children).forEach(child => {
                  list.appendChild(child.cloneNode(true));
                });
              });
              container.classList.remove('hidden');
            } else {
              container.classList.add('hidden');
            }
          }
        });
      }

      const option = {
        title: { top: 0, left: 'left', text: 'Activity', textStyle: { fontSize: 14 } },
        tooltip: {
          position: 'top',
          formatter: function (p) {
            const date = p.data[0];
            const value = p.data[1];
            const details = (window.heatmapDetails && window.heatmapDetails[date]) ? window.heatmapDetails[date] : null;
            let html = '<div>' + date + ' : ' + value + ' 件</div>';
            if (details && details.breakdown) {
              Object.keys(details.breakdown).forEach(name => {
                html += '<div>' + name + ': ' + details.breakdown[name] + '</div>';
              });
            }
            return html;
          }
        },
        visualMap: {
          min: 0,
          max: 10,
          type: 'piecewise',
          orient: 'horizontal',
          left: 'right',
          bottom: 0,
          pieces: [
            { min: 0, max: 0, color: '#ebedf0' },
            { min: 1, max: 3, color: '#9be9a8' },
            { min: 4, max: 6, color: '#40c463' },
            { min: 7, max: 9, color: '#30a14e' },
            { min: 10, color: '#216e39' }
          ]
        },
        calendar: {
          top: 40,
          left: 'center',
          cellSize: [13, 13],
          range: range,
          splitLine: { show: false },
          itemStyle: { borderWidth: 0, borderColor: '#fff' },
          yearLabel: { show: false },
          dayLabel: { firstDay: 1, nameMap: ['Sun', 'Mon', '', 'Wed', '', 'Fri', ''] },
          monthLabel: { nameMap: 'en' }
        },
        series: {
          type: 'heatmap',
          coordinateSystem: 'calendar',
          data: chartData,
          itemStyle: {
            borderRadius: 3,
            borderColor: '#fff',
            borderWidth: 2
          }
        }
      };
      myChart.setOption(option);
    }

    // 初期描画
    renderECharts('');

    // フィルタリング関数をグローバルに定義
    window.filterHeatmap = function(btn, parentId) {
      // ボタンのアクティブ状態切り替え
      const container = btn.closest('.join');
      container.querySelectorAll('.btn').forEach(b => {
        b.classList.remove('btn-active', 'btn-primary');
      });
      btn.classList.add('btn-active', 'btn-primary');

      // 再描画
      renderECharts(parentId);
    };

    // リサイズ対応
    window.addEventListener('resize', function() {
      if (myChart) myChart.resize();
    });
  })();
</script>
