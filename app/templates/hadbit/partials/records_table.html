{% from "hadbit/partials/popmenu_macros.html" import render_log_row %}
{% if not oob and not update %}
<div id="records-container">
  <div class="flex mb-4">
    <div class="join">
      <button class="join-item btn btn-sm btn-active btn-primary"
              onclick="filterLogs(this, '')">
        全て
      </button>
      {% set unique_parents = [] %}
      {% set seen_ids = [] %}
      {% for log in logs %}
        {% if log.parent_item_id and log.parent_item_id not in seen_ids %}
          {% set _ = seen_ids.append(log.parent_item_id) %}
          {% set _ = unique_parents.append({'id': log.parent_item_id, 'name': log.parent_short_name}) %}
        {% endif %}
      {% endfor %}
      {% for parent in unique_parents %}
      <button class="join-item btn btn-sm"
              onclick="filterLogs(this, '{{ parent.id }}')">
        {{ parent.name }}
      </button>
      {% endfor %}
    </div>
  </div>
<div id="records-list" class="grid grid-cols-1 md:grid-cols-3 gap-4 items-start" {% if swap_all %}hx-swap-oob="true"{% endif %}>
  {% set ns = namespace(current_date=None) %}
  {% for log in logs %}
    {% set log_date = log.done_at.strftime('%Y-%m-%d') %}
    {% if ns.current_date != log_date %}
      {% if ns.current_date is not none %}
        </div></div></div>
      {% endif %}
      <div class="card bg-base-100 shadow-sm border border-base-200 overflow-visible">
        <div class="card-body p-4">
          <h3 class="card-title text-lg border-b border-base-200 mb-2 pb-2">{{ log_date }}</h3>
          <div class="flex flex-col">
      {% set ns.current_date = log_date %}
    {% endif %}
    
    {{ render_log_row(log, update=False) }}

    {% if loop.last %}
      </div></div></div>
    {% endif %}
  {% endfor %}
</div>
</div>
{% else %}
  {% for log in logs %}
    {{ render_log_row(log, update=update) }}
  {% endfor %}
{% endif %}

<script>
  function filterLogs(btn, parentId) {
    // ボタンのアクティブ状態切り替え
    const container = btn.closest('.join');
    container.querySelectorAll('.btn').forEach(b => {
      b.classList.remove('btn-active', 'btn-primary');
    });
    btn.classList.add('btn-active', 'btn-primary');

    // ログ行の表示切り替え
    const rows = document.querySelectorAll('.record-row');
    rows.forEach(row => {
      const shouldShow = !parentId || row.dataset.parentId === parentId;
      row.classList.toggle('hidden', !shouldShow);
    });

    // 日付カードの表示制御（表示されているログ行がないカードは隠す）
    document.querySelectorAll('#records-list .card').forEach(card => {
      const hasVisibleRows = card.querySelectorAll('.record-row:not(.hidden)').length > 0;
      card.classList.toggle('hidden', !hasVisibleRows);
    });
  }
</script>
